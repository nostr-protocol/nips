# NIP-90: Data Vending Machines

`draft` `optional`

## Abstract

This NIP defines a standardized interaction pattern for Nostr Data Vending Machines (DVMs). It focuses on how clients discover DVM capabilities, request jobs, and receive results. This NIP decouples the core DVM interaction from specific job-type implementations, which should be defined in separate documents.

## Core Concepts

This NIP establishes the following fundamental principles for DVM interaction:

### Ephemeral Events

All DVM communication (job requests, job results, status updates) MUST use ephemeral events (kinds `20000 <= k < 30000`). This prevents the indefinite storage of potentially large or numerous job-related events on relays.

*   **Job Requests:** Kinds `25000` to `25999` (Specific kind depends on the job type).
*   **Job Results:** Kinds `26000` to `26999` (Specific kind corresponds 1:1 to the request kind, e.g., `25002` -> `26002`).
*   **Job Feedback:** Kind `27000`.

### DVM Announcement (Kind 35600)

DVMs MUST announce their presence, capabilities, and input schema using a replaceable `kind: 35600` event. This allows clients to discover DVMs and understand how to formulate job requests.

### JSON-RPC Payload

The `content` field of DVM-related events (requests, results, feedback with data) MUST contain a JSON string conforming to the [JSON-RPC 2.0 Specification](https://www.jsonrpc.org/specification).

*   **Requests (Job Request):** MUST include `jsonrpc: "2.0"`, the `method` name (e.g., `run_job`, `get_schema`), and `params` (an object or array).
*   **Responses (Job Result):** MUST include `jsonrpc: "2.0"`, either a `result` field or an `error` field.

### JSON Schema for Input Definition

DVMs MUST define the expected input parameters for their supported job types using [JSON Schema](https://json-schema.org/). This schema allows clients to validate inputs and understand parameters before sending a job request. The mechanism for discovering this schema is defined below.

### Tag Usage

Nostr event `tags` MUST be used for Nostr-specific metadata and context.

*   `e`: Referencing related events (e.g., the job request event in a job result/feedback).
*   `p`: Referencing user profiles (e.g., the DVM pubkey in a request, the client pubkey in a response).
*   `status`: Providing job status in Feedback events (`processing`, `success`, `error`, `payment-required`).

Input parameters for the DVM's task MUST be placed within the JSON-RPC `params` object inside the event's `content` field.

## Discovery and Schema Retrieval

Clients need a reliable way to find DVMs and understand how to interact with them.

### DVM Announcement (Kind 35600)

This replaceable event serves as the DVM's discoverable metadata and schema definition. DVMs SHOULD publish and maintain this event.

**Tags:**

*   `k`: (Required) One or more tags listing the ephemeral job request kinds supported (e.g., `["k", "25002"]`, `["k", "25100"]`). Clients discover DVMs by filtering on this tag.
*   `name`: (Optional) DVM name.
*   `about`: (Optional) DVM description.
*   `picture`: (Optional) URL for DVM picture.
*   `methods`: (Required) Lists the supported JSON-RPC method names. `run_job` MUST be included if the DVM performs tasks *for the job kinds listed in the `k` tags*. `get_schema` MUST be included for schema retrieval. While custom methods are possible, these two form the standard interface.

**Content:**

*   (Required) The DVM's complete JSON Schema definition as a JSON string. This schema MUST describe the inputs for *all* methods and job kinds listed in the tags.

**Example DVM Announcement (Kind 35600):**
```json
{
  "kind": 35600,
  "pubkey": "<dvm_pubkey>",
  "created_at": <timestamp>,
  "tags": [
    ["k", "25002"],
    ["name", "TranslationDVM"],
    ["about", "Translates text between languages"],
    ["picture", "https://image.com/..."],
    ["methods", "run_job", "get_schema"]
  ],
  "content": "{\"type\": \"object\", \"properties\": {\"run_job\": {\"type\": \"object\", \"properties\": {\"input\": {\"type\": \"string\"}, \"target_lang\": {\"type\": \"string\"}}, \"required\": [\"input\", \"target_lang\"]}, \"get_schema\": {\"type\": \"object\", \"properties\": {}}}, \"required\": []}"
}
```

Clients can find DVMs by querying relays for `kind: 35600` events with a specific `k` tag. The schema is directly available in the `content`.

### Schema Retrieval via `get_schema` Method
As an alternative to query for the announcement event of a specific dvm or job type, clients MAY request the schema directly from one or more DVMs using a Job Request event (`kind: 25xxx`).

To request from a specific DVM, include its pubkey in the `p` tag. To broadcast the request to any listening DVM supporting the specified `kind`, omit the `p` tag.

*   **Request:** Send a `kind: 25xxx` (any kind the DVM supports) event with `content` containing a JSON-RPC request: `{"jsonrpc": "2.0", "method": "get_schema", "params": {}}`. The `kind` used indicates the job type context, but the `get_schema` method itself requests the DVM's input schema.
*   **Response:** The DVM responds with a `kind: 26xxx` (corresponding to the request kind) event. The `content` contains a JSON-RPC response. The `result` field MUST follow the Standard Output Object Types, containing an array with a single object: `[{ "type": "json", "data": "<JSON_Schema_String>" }]`. An `error` object is returned on failure.

**Example `get_schema` Request Event (Kind 25002 - Broadcast):**

```json
{
  "kind": 25002, // Requesting schema in the context of specific job
  "pubkey": "<client_pubkey>",
  "created_at": <timestamp>,
  "tags": [],
  "content": "{\"jsonrpc\": \"2.0\", \"method\": \"get_schema\", \"params\": {}}",
  "sig": "<signature>"
}
```

**Example `get_schema` Response Event (Kind 26002):**

```json
{
  "kind": 26002, // Corresponding to the 25002 request
  "pubkey": "<dvm_pubkey>",
  "created_at": <timestamp>,
  "tags": [
    ["e", "<get_schema_request_event_id>"],
    ["p", "<client_pubkey>"]
  ],
  "content": "{\"jsonrpc\": \"2.0\", \"result\": [{\"type\": \"json\", \"data\": \"<JSON_Schema_String>\"}]}",
  "sig": "<signature>"
}
```

## Job Execution Flow

### 1. Client Sends Job Request (Kind 25xxx)

To initiate a job, the client sends an ephemeral `kind: 25xxx` event (where `25xxx` matches a kind supported by the DVM).

*   **Content:** A JSON-RPC 2.0 request string.
    *   `method`: `run_job` (or other method listed in DVM announcement).
    *   `params`: Input parameters conforming to the DVM's published JSON Schema for the requested method/kind.
*   **Tags:**
    *   `p`: DVM's pubkey.
    *   Other tags MAY be included for context (e.g., `e` tag referencing an input note).

**Example Job Request Event (Kind 25002 - Translation):**

```json
{
  "kind": 25002,
  "pubkey": "<client_pubkey>",
  "created_at": <timestamp>,
  "tags": [
    ["p", "<dvm_pubkey>"]
  ],
  "content": "{\"jsonrpc\": \"2.0\", \"method\": \"run_job\", \"params\": {\"input\": \"Hello world\", \"target_lang\": \"es\"}}",
  "sig": "<signature>"
}
```

### 2. DVM Provides Feedback (Kind 27000)

DVMs SHOULD provide feedback on job status using ephemeral `kind: 27000` events.

*   **Kind:** `27000`.
*   **Recipient:** Client's pubkey (`p` tag).
*   **Reference:** Job request event ID (`e` tag).
*   **`status` Tag:** MUST indicate current state (`processing`, `error`, `payment-required`, `success`, etc.).
*   **Payment Tags:** If `status` is `payment-required`, MUST include payment details (e.g., `amount`, `bolt11`, `cashuReq`).
*   **`content`:** MAY contain a human-readable message or structured status data.

**Example Job Feedback Event (Kind 27000 - Payment Required):**

```json
{
  "kind": 27000,
  "pubkey": "<dvm_pubkey>",
  "created_at": <timestamp>,
  "tags": [
    ["p", "<client_pubkey>"],
    ["e", "<job_request_event_id>"],
    ["status", "payment-required"],
    ["amount", "1000", "bolt11", "lnbc1..."]
  ],
  "content": "Payment required to process translation job.",
  "sig": "<signature>"
}
```

**Example Job Feedback Event (Kind 27000 - In Progress):**

```json
{
  "kind": 27000,
  "pubkey": "<dvm_pubkey>",
  "created_at": <timestamp>,
  "tags": [
    ["e", "<job_request_event_id>"],
    ["p", "<client_pubkey>"],
    ["status", "processing"]
  ],
  "content": "Job is being processed...",
  "sig": "<signature>"
}
```

### 3. DVM Sends Job Result (Kind 26xxx)

Once the job is completed, the DVM sends the result using the corresponding ephemeral `kind: 26xxx` event.

*   **Kind:** `26xxx` (corresponding to the `25xxx` request kind).
*   **Content:** A JSON-RPC 2.0 response string.
    *   `result`: Contains the job output if successful. MUST be an array of objects, each having a `type` field and corresponding data field(s).
    *   `error`: Contains a JSON-RPC error object if the job failed.
*   **Tags:**
    *   `e`: ID of the `kind: 25xxx` Job Request event.
    *   `p`: Pubkey of the client who made the request.

#### Standard Output Object Types:

The `result` array MUST contain *Standard Output Objects*, each with a `type` field indicating the nature of the `data` field. The job-specific document MUST specify which output types (from this list or others defined by that document) are expected for that particular job kind. This base NIP defines the following standard types:

*   **Text:** `{ "type": "text", "data": "Result text..." }`
*   **Image:** `{ "type": "image", "data": "<base64_data>", "mimeType": "image/png" }`
*   **Audio:** `{ "type": "audio", "data": "<base64_data>", "mimeType": "audio/wav" }`
*   *(Job-specific documents may define other standard types)*

**Example Job Result Event (Kind 26002 - Success):**

```json
{
  "kind": 26002,
  "pubkey": "<dvm_pubkey>",
  "created_at": <timestamp>,
  "tags": [
    ["e", "<job_request_event_id>"],
    ["p", "<client_pubkey>"]
  ],
  "content": "{\"jsonrpc\": \"2.0\", \"result\": [{\"type\": \"text\", \"data\": \"Hola mundo\"}]}",
  "sig": "<signature>"
}
```

**Example Job Result Event (Kind 26002 - Error):**

```json
{
  "kind": 26002,
  "pubkey": "<dvm_pubkey>",
  "created_at": <timestamp>,
  "tags": [
    ["e", "<job_request_event_id>"],
    ["p", "<client_pubkey>"]
  ],
  "content": "{\"jsonrpc\": \"2.0\", \"error\": {\"code\": -32001, \"message\": \"Unsupported target language\"}}",
  "sig": "<signature>"
}
```

## Client Responsibilities

**MUST:**

1.  Discover DVMs via `kind: 35600` announcements or `get_schema` requests.
2.  Parse the DVM's JSON Schema (from announcement `content` or `get_schema` result) to understand required `params`.
3.  Send Job Requests using ephemeral `kind: 25xxx` events.
4.  Format `content` of Job Requests as a valid JSON-RPC 2.0 request string (with `method` and `params`).
5.  Include the target DVM's pubkey (`p` tag) in Job Requests (unless broadcasting a `get_schema` request).
6.  Listen for Job Results (`kind: 26xxx`) and Feedback (`kind: 27000`) tagged with its pubkey (`p` tag) and the request's event ID (`e` tag).
7.  Handle potential JSON-RPC `error` responses in `kind: 26xxx` results.
8.  If payment is requested (`kind: 27000` with `status: payment-required`), handle the payment flow (e.g., NIP-57 zap receipt).

## DVM Responsibilities

**MUST:**

1.  Use ephemeral events (`kind: 26xxx`, `27000`) for Job Results and Feedback.
2.  Format `content` of Job Results as a valid JSON-RPC 2.0 response string (with `result` or `error`).
3.  Include the client's pubkey (`p` tag) and request event ID (`e` tag) in Job Results and Feedback.
4.  Listen for Job Requests (`kind: 25xxx`) for the kinds listed in its announcement's `k` tag.
5.  Validate incoming `params` against its schema. Reject invalid requests with a JSON-RPC error in a `kind: 26xxx` response.
6.  Respond to `get_schema` requests with the schema string wrapped in the standard output format (`[{ "type": "json", "data": "<Schema_String>" }]`) in the `result` field of a `kind: 26xxx` event.
7.  For successful `run_job` requests, return an array of standard output objects in the `result` field of the `kind: 26xxx` response.
8.  Sign all announcement (`35600`), result (`26xxx`), and feedback (`27000`) events.

**SHOULD:**

1.  Announce capabilities using a replaceable `kind: 35600` event with:
    *   `k` tag(s) for supported `25xxx` kinds.
    *   `methods` tag listing supported JSON-RPC methods (`run_job`, `get_schema`).
    *   Optional `name`, `about`, `picture` tags.
    *   The full JSON Schema string in the `content` field.
2.  Keep the `kind: 35600` announcement updated if capabilities change.
3.  Provide job status updates via `kind: 27000` Feedback events, especially for long jobs or errors.
4.  Use `kind: 27000` with `status: payment-required` and payment tags (`amount`, `bolt11`, `cashuReq`) to request payment. Wait for payment confirmation (e.g., NIP-57 zap) before proceeding.

## Relationship to Job-Specific NIPs

This NIP defines the *core interaction pattern*. Details for individual job types (e.g., `25002` translation) MUST be defined in separate documents. These documents specify:

1.  The exact `25xxx`/`26xxx` kinds used.
2.  The specific JSON Schema definition for the `params` of the `run_job` method for that kind.
3.  The expected structure and `type` fields for the output objects returned in successful `kind: 26xxx` results.
4.  Any standardized error codes specific to that job type.

Job-specific documents MUST adhere to the patterns defined here. DVMs MUST conform to both this core NIP and relevant job-specific documents.