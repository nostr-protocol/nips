NIP-102
=======

Private Event
-------------

`draft` `optional` `author:arthurfranca`

This NIP defines a new client to relay message to send private events.

## Private Event

A private event has the same format of a regular event but it
is expected to be fetched just by allowed pubkeys. The relay is
trusted to use [NIP-43](43.md) to restrict access to the private
event.

## Message

The message is similar to the [NIP-01](01.md) `EVENT` message but
has a configuration array as an extra argument:

`["PRIVATE_EVENT", {<event_JSON>}, [<configuration_array>]]`

The event author must be authenticated using NIP-43
before sending the message.

The message can be sent more than once by the event author
to change the configuration array.

If the configuration array is absent or empty, the event becomes public.

## Access Control

The private event can be accessed by its `author`, by a `pubkey`
referenced in the configuration array or by `pubkeys` inside the
event referenced in the configuration array as `p` tags.

The user fetches events as usual with NIP-01 `REQ` message.
Only allowed users authenticated to the relay using NIP-43 will
receive private events that match the filters.

## Configuration Array

The config array has atleast two items. The first is the identifier type and the second is the identifier value.

The identifier type can be `p`, `e`, `a` or `u`.

When `p`, the referenced pubkey value is allowed to access the private event.
For example, useful for DMs.

Identifier value for `e` and `a` types may be any event that contains `p`
tags. These `p` tags are the users allowed to access the private event.
For example `e` and `a` can be a list or a group
creation/metadata event that contains `p` tags (both encrypted or not).
The referenced event must be previously sent to the used relay.

Identifier value for `u` types may reference any unbounded list with each
item holding atleast one `p` tag, allowing, for example, for the creation of private
feeds meant to be read only by an unbounded number of paying subscribers.
The referenced unbounded list must have atleast one of its items previously
sent to the used relay.

Optionally, there is a third configuration array value with
a private key that can decrypt the `e` or `a` event (or `u` list events)
referenced as the second item using [NIP-44](44.md).
Note that **this is not the user's private key**, but a disposable one.
Similar to DMs, the disposable or the author private key can decrypt the
referenced event content.

Note that only the **author** of the event referenced in the config array
can set the disposable private key when publishing private events.

The author must have previously added the disposable private key,
if applicable (if the referenced event is to be encrypted),
to the referenced event (or events, in case of `u` indentifier)
inside a NIP-44 encrypted `privkey` tag next to the encrypted `p` tags.

The author will need it for the configuration array when publishing
a private event in reply to their own previous private event.
Other users won't need it when replying.

### Configuration Array Example

`["a", "<nip_51_list_address>", "<disposable_privkey>"]`

## Extra Event Field

When requesting events, if some of them are private, the `relay` MUST
attach to these private events an extra `config` attribute namespaced
in the `private` key holding the "configuration array"
**without** the "disposable privkey" array item.

Instead of the "disposable privkey" array item it must always add the author of
the event referenced in the config (their pubkey). The author will use it to check if
their referenced event holds a `privkey` tag (inside the encrypted `.content`)
it may need to privately reply to their own previous private event.

The extra field is important to build client interfaces that enable
configuration array editing features
and to allow replying in [Private Threads](#private-threads).

Example of a returned event:

```
{
  id: ...,
  kind: 1,
  // ...other event fields
  sig: ...,
  private: {
    config: ["a", "<nip_51_list_address>", "<nip_51_list_author_PUBKEY>"]
  }
}
```

### Private Threads

Private replies work by publishing the reply event using a `PRIVATE_EVENT` message
with the same config array identifier found in the extra `private.config` field
attached to the root message by relays or, for example,
attached to a chat creation/metadata.

Remember that only the **author** of the event referenced in the config array
can and will set the disposable private key in `PRIVATE_EVENT` messages,
if applicable (if the referenced event is encrypted),
be them for publishing private replies or any other private event.

**Important**: `Relays` must be aware that if it's not the author of the encrypted event
referenced in the config array the one who is publishing the private event,
the `PRIVATE_EVENT` message will **not** carry a "disposable private key" in the config array.

## OK Messages

When a relay receives a `PRIVATE_EVENT` message
with a configuration array referencing a missing event it must reply with
a failure NIP-01 `OK` message:

`["OK", "b1a649ebe8...", false, "missing-reference: missing referenced event"]`

If successful, it must send a success OK message:

`["OK", "b1a649ebe8...", true, ""]`

Considering (parameterized) replaceable events, if a new private version is published, it deletes and replaces the older private (or public) event version.

However, a new **public** replaceable event version (published with a regular
`EVENT` message) MUST NOT replace a previous **private** event version
and the relay must reply with a failure `OK` message:

`["OK", "b1a649ebe8...", false, "cant-replace-private: can't replace private event"]`
