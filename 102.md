NIP-102
=======

Private Event
-------------

`draft` `optional` `author:arthurfranca`

This NIP defines a new client to relay message to send private events.

## Private Event

A private event has the same format of a regular event but it
is expected to be fetched just by allowed pubkeys. The relay is
trusted to use [NIP-43](43.md) to restrict access to the private
event. It MUST have a `private` tag as explained in the
[Private Threads](#private-threads) section.

## Message

The message is similar to the [NIP-01](01.md) `EVENT` message but
has a configuration array as an extra argument:

`["PRIVATE_EVENT", {<event JSON>}, [<configuration array>]]`

The event author must be authenticated using NIP-43
before sending the message.

The message can be sent more than once by the event author
to change the configuration array.

If the configuration array is absent or empty, the event becomes public.

## Access Control

The private event can be accessed by its `author`, by a `pubkey`
referenced in the configuration array or by `pubkeys` inside the
event referenced in the configuration array as `p` tags.

The user fetches events as usual with NIP-01 `REQ` message.
Only allowed users authenticated to the relay using NIP-43 will
receive private events that match the filters.

## Configuration Array

The config array has atleast two items. The first is the identifier type and the second is the identifier value.

The identifier type can be `p`, `e`, `a` or `u`.

When `p`, the referenced pubkey value is allowed to access the private event.
For example, useful for DMs.

Identifier value for `e` and `a` types may be any event that contains `p`
tags. These `p` tags are the users allowed to access the private event.
For example `e` and `a` can be a list or a group
creation/metadata event that contains `p` tags (both encrypted or not).
The event should be sent to the used relay.

Identifier value for `u` types may reference any unbounded list with each
item holding one `p` tag, allowing, for example, for the creation of private
feeds meant to be read only by an unbounded number of paying subscribers.

Optionally, there is a third configuration array value with
a private key that can decrypt the `e` or `a` event (or `u` list events)
referenced as the second item using [NIP-44](44.md).
Note that **this is not the user private key**, but a disposable one.
Similar to DMs, the disposable or the author private key can decrypt the
referenced event content.

### Example

`["a", "<nip_51_list_address>", "<disposable_privkey>"]`

## Private Threads

Private replies work by referencing the same config array identifier of the root message.
This is available at the root messages's `private` tag,
**without** the "disposable privkey" array item. For example:

`["private", "a", "<nip_51_list_address>"]`

The reply itself MUST also have the same `private` tag to help with further replies.

**Important**: `Relays` receiving a `PRIVATE_EVENT` message without a "disposable privkey", should
check first if the "disposable privkey" it may have already received in a past `PRIVATE_EVENT`
message still works to decrypt the referenced event content. If that is the case, it should keep using
that key even though the current `PRIVATE_EVENT` message doesn't inform a key.

## Error Handling

When a relay receives a `PRIVATE_EVENT` message
with a configuration array referencing a missing event it should reply with
a failure `OK` message:

`["OK", "b1a649ebe8...", false, 'missing-reference: missing referenced event']`

When a relay receives a `PRIVATE_EVENT` message
with a configuration array referencing
an event with no `p` tags and no "disposable privkey"
was informed in the current or previous `PRIVATE_EVENT` messages
(meaning the relay can't decrypt the referenced event content in search for `p` tags),
the relay should send a failure `OK` message:

`["OK", "b1a649ebe8...", false, 'incomplete-reference: no "p" tags found in the referenced event']`
