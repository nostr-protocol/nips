NIP-D8
======

Nostr Key Migration
-------------------

`draft` `optional`

This NIP defines a simple mechanism which allows users to migrate to a new key and invalidate their current account. It combines signatures, social key recovery, Open Timestamp Attestations, and some trust assumptions to prevent hijacking by an attacker or loss of control through over-reliance on the social graph.

## Creating a Migration Key

A user can create a `kind 360` `precommit` event which lists one or more public keys that are authorized in advanced as possible `migration` keys.

All `kind 360` events MUST be accompanied by an [Open Timestamp Attestation](03.md) and published to all `migration` relays, as described below. If multiple conflicting `kind 360` events exist, the first one published MUST be used.

```typescript
{
  "kind": 360,
  "pubkey": "<identity pubkey>"
  "tags": [
    ["p", "<migration pubkey 1>"],
    ["p", "<migration pubkey 2>"]
  ],
  // Other fields
}
```

## Storing a Migration Key

Each private key designated in a `kind 360` as a `migration` key MUST be stored securely. Users may choose to use any method for storage and retrieval, but a basic social recovery setup is described here as a basis for interoperabilty.

### In-Band Social Key Recovery

Keys MUST be sharded following the [codex32 standard](https://secretcodex32.com/) for Shamir secret sharing. Each shard MUST then be sent to a different nostr user who the holder of the `identity` key trusts to publish a migration event on their behalf.

Holders of key shards SHOULD remain anonymous in order to prevent shard holder collusion, as well as additional attacks against shard holders.

TODO: Use Matt Lorentz's social recovery process for distribution.

## Migrating an Identity Key

When a user wishes to invalidate his current key, he must generate a new `successor` key, then contact the peers the shards were sent to out-of-band such that at least one `migration` key can be used to collaboratively sign a `kind 362` `migration` event.

TODO: Use Matt Lorentz's social recovery process for recovery.

```typescript
{
  "kind": 362,
  "pubkey": "<migration pubkey>",
  "tags": [
    ["p", "<successor pubkey>"],
    ["e", "<id of the precommit event>", "<relay hint>"]
  ],
}
```

All `kind 362` events MUST be accompanied by an [Open Timestamp Attestation](03.md) and published to all `migration` relays, as described below. If multiple conflicting `kind 362` events exist, the first one published MUST be used. Migration keys MUST NOT be used for anything other than signing a single `kind 362` event.

Clients SHOULD NOT rely on `migration` events existing long-term, but should make an effort to help users move away from the previous `identity` key as soon as possible. However, clients SHOULD NOT follow `successor` keys without user consent.

When migrating to a new key, users MAY re-publish any content or metadata they want to be preserved on their account. Implementations SHOULD NOT attempt to establish a live link between the old and new identities.

## Opting Out

Users SHOULD publish a `kind 360` event as soon as their account becomes valuable to them. If a key is leaked before a `migration` event is published, the attacker will be able to migrate to their own key, locking the original user permanently out of their account.

If a user prefers not to enable key migration on their account, they SHOULD publish a `kind 360` event with no designated `successor` keys, making it impossible to migrate.

## Relay Selection

This NIP is highly dependent on the first `kind 360` event being readily available non-interactively. If the wrong `precommit` event is chosen, an attacker may be able to migrate a user's identity to another key.

Nostr relays offer no consistency guarantees, which means commodity relays cannot support this use case. Outbox relays can't be trusted because an attacker with access to a user's private key can update them. Any trusted relays become attack vectors, since they can selectively omit entries, facilitating a migration attack.

These risks can be mitigated in classically nostr fashion by spreading trust across a larger number of relays. These relays MUST be independently run, and their owners MUST have an incentive to prevent account theft, which can only be assessed manually.

All of these relays would have to collude in order to prevent a correct migration from occurring. All `kind 360` and `362` events MUST be published to these relays along with OTS attestations.

These relays MUST validate Open Timestamp attestations, and ensure that only `kind 362` events that match a valid `kind 360` event are stored. Clients SHOULD also validate events as well.

However these relays are chosen, the entire network MUST use the same set. Network partitioning is unacceptable in this case.

