NIP-24
======

Sealed Private Messages and Private Group Chats
-----------------------------------------------

`draft` `optional` `author:vitorpamplona` `author:kieran` `author:paulmillr` `author:staab`

This NIP creates an encrypted messaging protocol for direct messages and small group chats with the following privacy guarantees: 
1. **Superior Encryption**: Messages are encrypted with XChaCha ([NIP-44](44.md)) to each participant's public key individually.
2. **No Metadata Leak**: Chat participant identities, each message's real date and time, event kinds, and other tags are all hidden from the public
3. **Onion Layers**: Senders and receivers cannot be linked with public information alone ([NIP-59](59.md)).
4. **Trust-minimized**: DM/Group members cannot expose verifiable details of your message, including the metadata, without exposing their entire user and all of their other messages (private key)
5. **No Identifiers**: There is no central queue, channel or otherwise converging event id to link or count all messages in the same group. 
6. **No Moderation**: There is no group admins, no invitations or bans.
7. **No Secrets**: There is no chatroom secret key that can leak or be mistakently shared
8. **Fully Recoverable**: Messages can be fully recoverable in any client with the receiver or the sender's private key
9. **Forward Secrecy Option**: Users and clients can opt-in for "Disappearing Messages" that are not recoverable with their private key
10. **Uses Public Relays**: The protocol's messages can flow through public relays without loss of privacy. Private relays can increase privacy further, but they are not needed.
11. **Cold Storage**: Users will be able to also opt-in to sharing messages with a new key exclusive for DM backup and recovery.
11. **Composible**: The protocol is extensible to make any other event kind fully private (private likes, private reports, private long-form content, etc)

The resulting protocol is a convergence of many past proposals, including [NIP-44](44.md), [NIP-59](59.md), [NIP-24](https://github.com/nostr-protocol/nips/pull/56), [NIP-103](https://github.com/nostr-protocol/nips/pull/499), [NIP-76](https://github.com/d-krause/nostr-nips/blob/nip76-draft-2/76.md). It brings their best ideas together in a slighly different approach. 

## Overview

This protocol uses two main concepts to secure the privacy of the event: Sealed Rumor Events and Gift Wraps ([NIP-59](https://github.com/nostr-protocol/nips/pull/716)). The target event is first **unsigned** (to make it unverifiable if it leaks -> "Rumor"), then Sealed, and then GiftWrapped.

As an early example: this is the flow of a private message: 

1. Target Event   `To Receiver: "Hi Receiver, did you finish the transfer? -- Signed, Sender"`
2. Rumor         `To Receiver: "Hi Receiver, did you finish the transfer? -- From Sender" (unsigned)`
3. Sealed Rumor  `<ENCRYPTED Rumor> -- Signed, Sender`
4. Gift Wrap      `To Receiver: <ENCRYPTED Sealed Rumor> -- Signed, Anon`

The Gift Wrap is the only event sent to relays. 

## 1. A new ChatMessage Kind as Rumor

This NIP defines `Kind:14` as a Chat Message in a similar way `Kind:4` does, but it's never signed and if it is signed, the information in it is **fully public**. This event requires the rest of the protocol to make it private. 

Direct Message Payload: 
```js
{
  "id": "<The usual hash>",
  "pubkey": "<author key in hex>",
  "content": "This is a DM",
  "kind": 14,
  "created_at": 1686840217,
  "tags": [ <one or more receivers, mentions, citations, additional fields like content-sensitivity, etc> ],
}
```

The `.content` contains the message. `pubkey` + `p` tags MUST be used to define the Chatroom ID of the group. 

## 2. The Sealed Rumor Event Kind

A Sealed Rumor is a `kind:13` event that authenticates the author of the encrypted message. In this NIP, it wraps the `kind:14` event (the Rumor) and is signed with the sender's regular key. 

The Sealed Rumor is **always** encrypted to a receiver's pubkey but there is no `p` tag pointing to the receiver. The receiver information is not public. The only public information in this event is who is signing it. 

```js
{
  "id": "<The usual hash>",
  "pubkey": "<Real Author's PubKey>",
  "content": "<XCHACHA-Encrypted Rumor Kind>",
  "kind": 13,
  "created_at": 1686840217,
  "tags": [],
  "sig": "<Real Author's PubKey Signature>"
}
```

Clients MUST verify if pubkey of the `kind:13` is the pubkey on the `kind:14`, otherwise any author can impersonate others by simply changing the pubkey on `kind:14`

Tags MUST must always be empty. The inner event MUST always be unsigned. The encryption algorithm MUST use [NIP-44](44.md). 

## 3. Gift Wrap Event Kind

A GiftWrap event is a `kind:1059` event that wraps the `kind:13` event. It is signed by single-use (random) key and is `p`-Tag-addressed to the receiver. The only public information is the receiver's public key. 

```js
{
  "id": "<The usual hash>",
  "pubkey": "<Random, one-time-use PubKey>",
  "content": "<XCHACHA-Encrypted Kind 13>",
  "kind": 1059,
  "created_at": 1686840217,
  "tags": [
    [ "p", "<Receiver>" ]
  ],
  "sig": "<Random, one-time-use PubKey Signature>"
}
```

A `p` tag for the recipient MUST be added to the `tags` field of a GiftWrap. 

Clients pull all GiftWraps citing their user and decrypt the gift-wrapped event with the user's private key to get the Seal and to know where this Gift is coming from. After breaking the seal, the Client can see the message, date/time as we as any pertinent tags. 

Note: Gift wraps alone are an effective tool to hide information from the public. However, the inner event can be easily re-broadcasted, breaking the privacy of the sender and leaking its metadata (e.g. author, event kind, dates, tags, etc). Thus in this NIP, the GiftWrap MUST wrap a Sealed Rumor Event to make sure the receiver cannot break the privacy guarantees when re-broadcasting it. 
 
## 5. Private Message Algorithm

To send a private message, create a kind `Kind:14` with the message in its `.content` and a p-Tag to the receiver. Other tags are encouraged to be added, such as `content-sensitivity` if the content is NSFW and `subject` to create a name to the conversation. 

Once `Kind:14` is created, remove the signature and serialize as JSON. Encrypt the serialized `Kind:14` to the receiver's public key and seal it with a `kind:13` event, signed by the sender's main key. 

For each receiver: 

1. Create a new key, serialize the seal, and encrypt it into a `kind:1059` with a tag to the receiver, signed by the new random key. 
2. Broadcast the `kind:1059` event to the relays of the receiver. 

For the sender: 

1. Create a new key, serialize the seal, and encrypt it into a `kind:1059` with a tag to the sender, signed by the new random key. 
2. Broadcast the `kind:1059` event to the relays of the sender. 

## 6. Private Group Chat Algorithm

Private Group chats are `Kind:14`s for more than one `p` tag. There is no channel definition event. The set of authors + recipient keys defines a group.

To send a private message to a group, create a kind `Kind:14` event with the message in its `.content` and add a p-Tag to each receiver. Other tags are encouraged to be added, such as `content-sensitivity` if the content is NSFW and `subject` to create a name to the conversation. Once `Kind:14` is created, remove the signature and serialize it as JSON.

For each receiver: 

1. Encrypt the serialized `Kind:14` to the **receiver's public key** and seal it with a `kind:13` event, signed by the sender's main key. 
2. Create a new key, serialize the seal, and encrypt it into a `kind:1059` with a tag to the **receiver**, signed by the new random key. 
3. Broadcast the `kind:1059` event to the relays of the **receiver**. 

For the sender: 

1. Create a new key, serialize the seal, and encrypt it into a `kind:1059` with a tag to the **sender**, signed by the new random key. 
2. Broadcast the `kind:1059` event to the relays of the **sender**. 

Clients SHOULD render every distinct set of author + recipient pubkeys as a group with continuing conversations. If a new p tag is added, a new group is created. 

The `subject` tag defines any name for the group or the current topic of the discussion. Any member of the group can change the subject. 

## 7. Final Considerations

This proposal makes heavy use of one-time keys to elevate the privacy design of Nostr messages. It can be applied to any Nostr event kind (e.g. private reactions), but the focus here is on private messages. For instance, the use of a Rumor Event enhances a paid-subscriber-only event kind by making it difficult (not impossible) to leak the paid content in a publicly verifiable payload. 

It's worth noting that the only created_at time that matters is with the Rumor event. All the other time-attributes SHOULD be tweaked to reduce the time-collision of send and receive Gift Wraps and Sealed Events.

Relays may choose not to store gift wrapped events due to them not being publicly useful. Clients MAY choose to attach a certain amount of proof-of-work to the wrapper event per NIP-13 in a bid to demonstrate that the event is not spam or a denial-of-service attack.

To protect recipient metadata, relays SHOULD only serve kind 1059 events intended for the marked recipient. When possible, clients should only send wrapped events to read relays for the recipient that implement AUTH, and refuses to serve wrapped events to non-recipients.

## 8. Private Group Chat, Step by Step

Let's send a message from `5b107933d9520411dbc6ed9ece42bbec8b930978671a6e9782528a74d70eb5e6` to `2f27f7d08bd618c4c9a050d923ed915a693ecb3e5d399b26ef0829f29a51035f` and `2f3b57b49531b5fc714307f53eda525eacf1733f5dc30e9c2ac57b60045c3e28`, asking "Who is going to the party tonight?"

### 8.1. Create a ChatMessage event

Create a `kind:14` with the message, the receivers, and any other tags you want, signed by the author. 

```json
{
  "id":"8db65e089967d0be99f367f5f242678ba91bd20bd5e1a0a3b90bb2ebfd15e51d",
  "pubkey":"4e47afb3ce48dcc51f6b270342e64586906c01dcb13750a769379a3d201da426",
  "created_at":1692241796,
  "kind":14,
  "tags":[
    [ "p", "c8e87f7a1fa75d203563932f843f06c88d02d242744304804a63356cccf77768" ]
  ],
  "content":"Who is going to the party tonight?",
  "sig":"92512091dc1b1ae040a1cbd79d947f0669cba3f7664fd49f6b83d673880c474adc3927c56a89db6263f05f22123dc1ed1b557d7a1ee2df428dccac63d5ab140e"
}
```

### 8.2. Make it a Rumor

Remove the signature to make it unverifiable if leaked.

```json
{
  "id":"8db65e089967d0be99f367f5f242678ba91bd20bd5e1a0a3b90bb2ebfd15e51d",
  "pubkey":"4e47afb3ce48dcc51f6b270342e64586906c01dcb13750a769379a3d201da426",
  "created_at":1692241796,
  "kind":14,
  "tags":[
    [ "p", "c8e87f7a1fa75d203563932f843f06c88d02d242744304804a63356cccf77768" ]
  ],
  "content":"Who is going to the party tonight?",
}
```

### 8.3. For each of the 3 participants

#### 8.3.1. Seal the Rumor
   
Encrypt the JSON-Stringified Rumor with the **Sender**'s key to the participant, create a `kind:13` event and sign it with the **Sender**'s key

```json
{
  "id":"fc31b72ac267e83e62bee591d2710cfa3499f662dbc5d1976c00d87baf455680",
  "pubkey":"4e47afb3ce48dcc51f6b270342e64586906c01dcb13750a769379a3d201da426",
  "created_at":1692241796,
  "kind":13,
  "tags":[],
  "content":"AXo1T3v/433NRLR2SFTc65/m3cmggPQCRQdCKygNZs8LAT1QWW2UB1VfGTg17vC6kC9Wz3+9KDLSbsRwHwhBtwAMqelJG2b59bRwlZHjNNimP7FyEU6/ROsKehiHDRt+z9tV6M0uCLjrGF90tCXLrkNWo7YRLi6nSEGy/T6fVgr397mGv6H2q8+asqwb1psqs1+SpuSa1pe7OqHSEeD/Ze9ekJka4lpaOiYDUo9RX2Xij6J6Nr3KrN74Nj3Y2j1mhCFcfAoAfaetr4GBH9KkcNmwrsDANje/9yApFbVXNOuc4DeyYXoPIQInUsDED4fSJ4yl5uk70PURS5VFaaTwyIN2Qt6Y2pPZx/Oh3J/2vadew2twQZhrj0NSt6FYUCqG6aC90T+M/lRevukwgkeeM/PJ53Q7lAafO49lFiZ2G9QG+Ts41gfyWAaduVQ3XkFOxA==",
  "sig":"416d75a49b24754056a989cc37c73185d86b839be7f854a029261c58d713b33ee0b5d872fc62b7b5973a467267ca0afdefc5b36c3cc399ec03259fc2a390eba5"
}
```
	
Notice how there are no tags declared in this event. 

#### 8.3.2. Get a Random Key 

We are using private key `3436da6d596c361dead74a207ceabb6c882f65ebc901a15b5be6a374fa91355f` in this example

#### 8.3.3. Create the Gift Wrap
   
Encrypt the JSON-Stringified `kind:13` with the Random key and create a Gift Wrap event for the participant

```json
{
  "id":"241cb12216baf8b926607f1a59d6e4bfa600711cdb894ba2a5be2dfee4571ad3",
  "pubkey":"40b97657efe99268f3610e8d8e290eee72c9d8a37bd77e8611ea2afa9151f2c5",
  "created_at":1692170196,
  "kind":1059,
  "tags":[
      [ "p", "c8e87f7a1fa75d203563932f843f06c88d02d242744304804a63356cccf77768" ]
  ],
  "content":"AR9rnY1zyDEJjZnjvms/94FSnIWk/p6OclnUQvLe+1Ucmp9AdvujwP7EVqD6aazpKrdZbzksUuNyVkyHtu+/79Z9oBsggUWXDWfLSCVcKTm+uJz/Qk8+/Ejx+U/umB7sC3RxKENshvblfBwwML87iR/cQFgwBoMylzxhFJTNSEZT5pv/JwysFWXcT14Ws4vVqOsWiGpaEv4gekUoHhoAh56FYPPnQFDfcDZzSzjRok6QYJ9oSt3m1p1Iylp9N9twjb2eLfdTKyav5w328aJaUqgh0/6QBs4HiE6TkFfBR75BuiDLrxgL3KGjuWPvki2zuHU91oaF7an+mUOzwzAWTNDgstvIuEr6txDdjUb+HH0wFSdQTNpFsAHM5JOPLRZb4URet2vk2dUJEsDQDSeErdDMMfUYvoD9/KgrELk8n71gHoB92ee9pEk361dTDCTKVkxIEvYsovw3RAA751iCOHfQJrAcxpct/qOWALdOzl1yWjABbz9DXEWTIPUqaIAepmiznFBrR+B1eBaYHgjqztWp0xB4+DDiy7KzchUEic6fphF7TbdJHH7RxmYfK20n5ExgJTKq+JOPepW+LE/9YP/v6Lljx8hvIHE7PZutQA8DfFhpWgFRx+1oV5atwIFC+7SdIHjYs8o7fmW6/X3qBC+PcAEKXSKdlDljrvhs0s/zO1Vq4OPls/V28dX5AWG8hA7xlSvSu0y+VrT0cKqFYAEXpp8vfE6+tTA0sD4y0sIFbyM8OAGFaRoZfNh7e+cN+mCQwgQj6vOtCsKavDsJoNsoFXmooxwffhJUCOpIpLigdijYB7MAs7/0DZGQe7puiV8Nj31NK250sdonC1AnfCjeuEMOOLbVf+FHCmjfqk6rAU7UT0ptJtBFDT1MLr3SmKBPf5Ub1tqPSCAhkRfQiHrMvq/0jqDBJVNOK57fx/r5U0wvqLlSfhfsnqrgytJc9Lhd/9oQAOvOHtiXSiaWgJjn2qwyvoS9jQDtmBY0hKTy3O4ej4rSBb9JJSnJt1Axcs9xUlyW7edRJKkWleJ+Qs4Et41D99ITshuG9Jxn0C9M634HQjENb8scY2Zj7ui1U7eO4A==",
  "sig":"2c592dff90967500e08a6202adf46deaf61992bf09494966544a600689dc6ee7349a746974807aa14457b2cda7b6c52ccfadf3e072e3890e2f46e4a3a25d24ef"
}
```
	
Notice that the signer is a random key.

#### 8.3.4. Broadcast Selectively
   
Broadcast the `kind:1059` event to the participant's relays only. Delete all the other events. 