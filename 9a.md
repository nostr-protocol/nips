NIP-9a
======

Nostr Relay Push
----------------

`draft` `optional`

This NIP defines a way for users to ask relays to push events to other servers.

Relays that implement this NIP MUST include `9a` in its [NIP 11](11.md) `supported_nips`, and MUST serve `kind 30390` events only to their author.

To register a push subscription, users may create a `kind 30390` event. This event MUST include the following tags:

- `d` - a random string
- `p` - the relay's [NIP 11](11.md) `self` pubkey

All other tags MUST be encrypted to the relay's `self` pubkey and placed in the event's `content` field:

- `relay` - the normalized url of the relay the event was sent to
- `filter` - a nostr filter for matching events (may appear multiple times)
- `ignore` - a nostr filter for ignoring matched events (may appear multiple times)
- `callback` - a URL indicating a callback url to forward events to

If a relay does not intend to fulfill the subscription, it SHOULD respond with an `OK` message with `false` as the result and a human-readable message.

When a relay receives a new event, it SHOULD match it against all current registrations and forward the event to authorized users by sending a `POST` request to the `callback` URL with `Content-Type: application/json`. The payload should be as follows:

```typescript
{
  id: string          // The event's id is provided to allow receiving servers to deduplicate events coming from multiple relays.
  relay: string       // The normalized url of the relay sending the notification
  pubkey: string      // The pubkey used to encrypt the ciphertext
  ciphertext: string  // JSON-encoded nostr event, NIP 44 encrypted to the 30390's pubkey to protect user privacy from intermediaries
}
```

If the `callback` URL responds with a `404` status code, the relay SHOULD delete the subscription. Relays MAY delete subscriptions at their discretion (e.g. due to expiration, inactivity, callback `500` errors, etc).

Clients MAY wish to sync subscription events periodically if they wish to ensure they continue receiving push notifications, and MAY delete subscription events as specified in [NIP 09](09.md)

If a relay receives a `kind 30390` event not p-tagged to itself, it SHOULD NOT store it. If a relay receives a `kind 30390` event whose `relay` tag does not match the relay's own URL, the relay SHOULD discard it.

## Example: Push Notifications

This NIP may be used to facilitate push notifications sent over FCM, APN, VAPID, or other types of server. To do so, a client developer might register device tokens with their own server, returning a `callback` to the client. The client would then construct `kind 30390` events signed by the user containing the `callback` to relays they want to get notifications from:

```typescript
{
  kind: 30390,
  pubkey: "<user pubkey>",
  content: nip_44([
    ["relay", "wss://relay.example.com/"],
    ["filter", "{\"kinds\": [1], \"#p\": [\"<user pubkey>\"]}"],
    ["ignore", "{\"#t\": [\"footstr\"]}"],
    ["callback", "https://my-callback.example.com/"]
  ]),
  tags: [
    ["d", "<subscription id>"],
    ["p", "<relay self pubkey>"]
  ],
}
```

When the subscription is no longer needed, clients might send delete events, or they may cancel the subscription with the push server directly, relying on the server to return a 404 to relays sending events.
