NIP-9a
======

Nostr Push Notifications
------------------------

`draft` `optional`

This NIP defines a way for users to register with relays to facilitate push notifications.

Relays that implement this NIP MUST include `9a` in its [NIP 11](11.md) `supported_nips`, and MUST NOT serve `kind 30390` events to anyone except their author.

To register, users may create a `kind 30390` event with their notification preferences. This event MUST include the following tags:

- `d` - a random string
- `p` - the relay's [NIP 11](11.md) `self` pubkey

All other tags MUST be encrypted and placed in the event's `content` field:

- `relay` - the normalized url of the relay the event was sent to
- `filter` - a nostr filter for matching events (may appear multiple times)
- `server` - a URL indicating a push server to forward events to
- `vapid_endpoint` - a VAPID push notification endpoint (web push only)
- `vapid_p256dh` - a VAPID p256dh key (web push only)
- `vapid_auth` - a VAPID auth key (web push only)
- `fcm_token` - a Firebase Cloud Messaging token (android only)
- `apns_token` - an APNs token (ios only)
- `ios_bundle_identifier` - a iOS app bundle identifier (ios only)
- `silent` - whether silent push notifications should be used

If a relay does not intend to fulfill the subscription, it SHOULD respond with an `OK` message with `false` as the result and a human-readable message.

When a relay receives a new event, it SHOULD match it against all current registrations and forward the event to authorized users by sending an HTTP `POST` request to the `server` URL with `Content-Type: application/json`. The payload should be as follows:

```typescript
{
  event: Event        // The signed nostr event
  config: string[][]  // The private tags provided by the user to the relay
}
```

If a relay receives a `kind 30390` event not p-tagged to itself, it SHOULD NOT store it. If a relay receives a `kind 30390` event whose `relay` tag does not match the relay's own URL, the relay SHOULD discard it. However, special purpose relays MAY choose to implement this behavior on behalf of other relays that do not support this NIP.

Relays SHOULD delete subscription events after 30 days. Clients MAY re-publish subscription events periodically if they wish to continue receiving push notifications. Clients MAY delete subscription events as specified in [NIP 09](09.md).
