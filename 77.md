NIP-77
======

Trust Clock
-----------

`draft` `optional` `author:arthurfranca` `author:melvincarvalho`

## What the Trust Clock Does?

It creates an event's `created_at` proof scoped to a client.
For more clients to trust the event's `created_at`, more `relay` signarutes
scoped to different clients are used.

## How to Use the Trust Clock?

A client first picks three relays to trust as a clock for a period
such as a month window. The client should keep
a log of all the trusted relay sets for each time window.

One way of selecting trusted relays is as follows:
a client collects relay hints from some of the events
its users fetch, excluding encrypted ones. Relays hints are
relay urls present in `e`, `p`, `a` or `relay` tags.
The 3 most trusted relays by the client user base
(relays that support this NIP) would be the 3 relay urls with more
relay hints in a month window.

The client trusted relay list at the time in seconds,
informed on the `at` query param, can be checked at
"https://client.example/.well-known/nostr/nip77.json?get=relays&at=<time-in-seconds\>":
`{ relays: ["https://relay1.example", "https://relay2.example", "https://relay3.example"] }`.

Clients can delegate trust by responding to
"https://client.example/.well-known/nostr/nip77.json?get=relays&at=<time-in-seconds\>"
with: `{ delegated_to: "https://another.client" }`

Now it is possible to ask relay to sign an `event.id` at
"https://relay1.example/.well-known/nostr/nip77.json?get=now&event=<percent-encoded-stringified-event-json\>"
and at the other two relay routes.

The relay will validate the event `id` and check if its `created_at` is near the current time.

The response is a JSON `{ sig: "<signature>", pubkey: "<relay1pubkey>" }`.
The signature uses the same Schnorr setup from NIP-01 to sign the received event `id`.

There is also "https://relay1.example/.well-known/nostr/nip77.json?get=pubkey&at=<time-in-seconds\>"
to check what was the canonical relay pubkey at the time: `{ pubkey: "<pubkey-at-that-time>" }`.
That's why a relay should keep a log of all the pubkeys used for each time window.

An user can use the response to prove its event's `created_at` is legit according to
relays, using atleast 2 signatures from the same set of relays a client trusts.
It should place the proof at an extra `clock` field like this:

```
{
  "id": ...,
  "kind": ...,
  // ... all regular event fields,
  clock: {
    c: ["https://client.example"], // clients to check trusted relay set
    s: [ // relays and corresponding signatures
      ["https://relay1.example", "<signature1>"]
      ["https://relay3.example", "<signature3>"]
    ]
  }
}
```

Relays receiving this event should store the event and the extra `clock` field.

The `clock.c` field can have multiple clients. It serves the purpose of claiming what
are the clients that will trust the relay signatures.
If using multiple clients' relay sets, the `clock.s` field
can have overlapping relays that don't need to be repeated.

### Validation

The signature can be validated with the pubkey from
"https://relay1.example/.well-known/nostr/nip77.json?get=pubkey&at=<event.created_at\>".

The client trusted relay list at the time can be checked at
"https://client.example/.well-known/nostr/nip77.json?get=relays&at=<event.created_at\>".
