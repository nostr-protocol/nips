NIP-A0
======

Keychains
---------

Keychains are a simple way for nostriches to have a secure master key with multiple less secure device keys.

Each key (the master key and each device key) publishes a replaceable keychain document that certifies the connection to other keys.

A keychain is an event with kind 19000 that proves links to other keys via tags. The content is empty.

This is a keychain for a device key, linking to it's master key:

```
{
  "pubkey": "<device-key>",
  "kind": 19000,
  "content": "",
  "tags": [
    ["masterkey", "<master-key>"],
  ]
}
```

This is a keychain for a master key, linking to it's possibly multiple device keys:

```
{
  "pubkey": "<master-key>",
  "kind": 19000,
  "content": "",
  "tags": [
    ["devicekey", "<device-key-1>", "<revocation-date>"],
    ["devicekey", "<device-key-2>"],
    ["devicekey", "<device-key-3>"],
  ]
}
```

Keychain events MUST not have more than one `masterkey` tag, and if they have a `masterkey` tag then they are from a device key and MUST NOT have any `devicekey` tags (e.g. key chains MUST only be one level deep).

Keys can be revoked by listing a stringified unix timestamp as the 3rd field in the tag representing the date after which events signed by the key should not be considered valid (clients MUST NOT compare to created_at dates to make this check).


Publishing Events from a Device Key
-----------------------------------

When publishing events from a device key, clients should add an `M` tag for the master key. In this way, clients will be able to search for all of a user's events by looking for the `M` tags instead of the `author`s. However then such events must be verified to have a valid keychain connection to that master key.

```
{
  "tags": [
    ["M", "<master-key>"],
  ]
}
```

To verifying a keychain connection, clients MUST refer to the keychain events (kind 19000) from both device key (pubkey of the event) and the master key (`M` tag) and verify in both of these keychain events that the other key is listed and does not have a revocation.

Relays MAY verify this as well to help mitigate DoS attacks.


Encryption
----------

The master key should generate a random 32-byte nonce root and send it to each device via giftwrap using a kind-19001 rumor:

```
{
  "id": "<id>",
  "pubkey": "<master-key-pub>",
  "content": "32-byte encrypted nonce root",
  "kind": 19001,
  "created_at": 1686840217,
  "tags": [],
 }
```

Since now each device has the same nonce root, encryptions can occur using derived keypairs and be decrypted by every device.

Encryption keypairs are generated as follows:

```
secret_key = sha256(hkdf(<nonce_root>, salt: utf8_encode('nipA0') + <kd-nonce-byte-array>))
```

Where `<kd-nonce-byte-array>` is specified by the party doing the encryption, and included within the encryption. This requires
NIP-44 v3 (not yet finalized).

Any device can decrypt because they all share the secret `<nonce_root>` and the `<kd-nonce-byte-array>` is available in plaintext
with the encrypted content.


Deletion
--------

[NIP-09](09.md) deletion requests made by one key for an event authored by another key should be honored if they share the same master key.

Phased Rollout
--------------

This NIP can be adopted with a phased roll out

Phase 1:
--------

* Some users create a new nostr keypair as their master key pair.
* These users post a kind-19000 keychain for their master key listing their current nostr key as a device key.
* These users post another kind-19000 keychain for their current nostr key, listing their master key.
* Some clients start adding `M` tags to the events that they publish from their device key.
* Clients start collecting or noticing users that have keychains.  For these users only, when seeking their events, these clients ask for events with an `M` tag listing their master key (rather than authored by their device key).

In this phase, no other device keys are created.

In this phase, nothing else is published from the master key other than the keychain.

In this phase, revocation is not yet recognized.


Phase 2:
--------

When many clients and users have completed Phase 1, Phase 2 can begin.

* Users can create multiple device keys and link them up.
* Revocation is now allowed and clients should honor it.


Rationale
---------

Nostr's main selling point is that you own your account. But that account doesn't have good management prospects. Once you are known by a key, you have little recourse if tht key should become compromised.

With a secure master key, the risk of an account being stolen can be more effectively reduced. Device keys open up the possibility of key rollover and revocation.

Because moving to such a structure is a big shift, this NIP has focused on simplicity.
