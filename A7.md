# NIP-A7

## Zap Reducer

`draft` `optional`

Relays may support the verb `ZAPREDUCE`, which provides a mechanism for obtaining aggregated values from zap receipt events.

## Motivation

Clients often need to calculate aggregate statistics on zap receipt events (kind 9735), such as sums, averages, or counts. Currently, this requires fetching all individual zap receipt events and performing calculations client-side, which is inefficient and resource-intensive. This NIP introduces a direct method for relays to provide these aggregations, improving performance and reducing bandwidth usage.

## Filters and return values

This NIP defines the verb `ZAPREDUCE`, which accepts a subscription id, an operation parameter, and filters as specified in NIP-01 for the verb `REQ`. Multiple filters are OR'd together and aggregated into a single result.

```
["ZAPREDUCE", <subscription_id>, {"op": <operation>, <filters>}]
```

Where `<operation>` is one of the supported reducer operations: `sum`, `avg`, `max`, `min`, `count`.

Reduce results are returned using a `ZAPREDUCE` response in the form:

```
["ZAPREDUCE", <subscription_id>, {"op": <operation>, "result": <value>, "currency": "sat", ...}]
```

The `currency` field is included to future-proof for potential non-satoshi zaps.

Additional fields in the response may vary based on the operation:

- `count`: Number of events included in the calculation (always included)
- `sum`: Total sum (included for `avg` operation)

Relays may use optimized or cached results to reduce compute requirements. In case a relay uses approximation, it MAY indicate it in the response with an `approximate` key:

```
["ZAPREDUCE", <subscription_id>, {"op": <operation>, "result": <value>, "currency": "sat", "count": <integer>, "approximate": <true|false>}]
```

Whenever the relay decides to refuse to fulfill the `ZAPREDUCE` request, it MUST return a `CLOSED` message.

## Supported Operations

### sum

Calculates the sum of all amounts in the matching zap receipt events.

### avg

Calculates the average amount of all matching zap receipt events.

### max

Returns the maximum zap amount among matching events.

### min

Returns the minimum zap amount among matching events.

### count

Returns the count of matching zap receipt events.

## Examples

### Total zap amount received by a user

```
["ZAPREDUCE", <subscription_id>, {"op": "sum", "kinds": [9735], "#p": [<pubkey>]}]
["ZAPREDUCE", <subscription_id>, {"op": "sum", "result": 123456, "currency": "sat", "count": 42}]
```

### Average zap amount for a specific note/event

```
["ZAPREDUCE", <subscription_id>, {"op": "avg", "kinds": [9735], "#e": [<event_id>]}]
["ZAPREDUCE", <subscription_id>, {"op": "avg", "result": 789, "currency": "sat", "count": 10, "sum": 7890}]
```

### Maximum zap received by a user

```
["ZAPREDUCE", <subscription_id>, {"op": "max", "kinds": [9735], "#p": [<pubkey>]}]
["ZAPREDUCE", <subscription_id>, {"op": "max", "result": 21000, "currency": "sat", "count": 15}]
```

### Count of zaps sent by a user

```
["ZAPREDUCE", <subscription_id>, {"op": "count", "kinds": [9735], "authors": [<pubkey>]}]
["ZAPREDUCE", <subscription_id>, {"op": "count", "result": 42, "count": 42}]
```

### Relay refuses to reduce

```
["ZAPREDUCE", <subscription_id>, {"op": "sum", "kinds": [9735]}]
["CLOSED", <subscription_id>, "refused: query too broad"]
```
