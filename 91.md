# NIP-91
## Group Channels (Extension to NIP-29)

`draft` `optional`

## Abstract

This NIP defines channels inside NIP-29 groups, allowing group discussions to be subdivided into named substreams similar to channels in Discord or Slack.

This specification is relay-scoped, fully backward-compatible with NIP-29, and does not redefine NIP-29 semantics.

## Motivation

NIP-29 provides group structure, membership, and relay-scoped moderation. As groups grow, a single timeline becomes difficult to navigate.

This NIP introduces channels:

- Preserves NIP-29 group semantics
- Adds per-group substreams (`i` tag)
- Enables efficient filtering and search
- Remains fully compatible with clients that do not yet support channels

## Terminology

- **Group**: NIP-29 group (`group_id`)
- **Channel**: Subdivision of a group (`channel_id`), unique per group

## Channel Definition

### kind: 39010 — Group Channel Definition

Uses kind 39010 (following NIP-29's 390xx convention for group-related metadata).

**Required tags:**

| Tag | Description |
|-----|-------------|
| `d` | Group ID (`group_id`) |
| `c` | Channel ID (`channel_id`), unique within group |

**Optional tags:**

| Tag | Description |
|-----|-------------|
| `name` | Human-readable channel name |
| `about` | Channel description |
| `picture` | Icon URL |
| `visibility` | `public` or `private` (see below) |
| `order` | Integer for display ordering |

### Rules:

- `channel_id` MUST be unique per `group_id`
- `channel_id` SHOULD contain only lowercase letters, numbers, and hyphens
- Multiple kind:39010 events with same `d`+`c` tags = updates (relay uses event with latest `created_at`)

**`visibility` tag:**
- `public`: All group members can see and post
- `private`: Relay enforces access control (implementation-specific)
- Omitted = public

Relays MAY restrict who can create/update channels.

### Example:

```json
{
  "kind": 39010,
  "tags": [
    ["d", "dev-nostr"],
    ["c", "general"],
    ["name", "General"],
    ["about", "General discussion"],
    ["order", "0"]
  ],
  "content": "",
  "created_at": 1234567890,
  "pubkey": "...",
  "id": "...",
  "sig": "..."
}
```

## Channel Reference in Messages

### kind:9 — Group Message

**Required tags:**

| Tag | Description |
|-----|-------------|
| `h` | Group ID |

**Optional tags:**

| Tag | Description |
|-----|-------------|
| `i` | Channel ID (matches `c` in 39010) |

### Rules:

- `i` MUST match `c` in a valid channel definition for the group
- Messages with unknown `i` SHOULD be rejected by relays
- Messages without `i` are not associated with any specific channel
- Clients MAY treat messages without `i` as they see fit (e.g., show in all channels, show in a special "uncategorized" view, or hide them)

### Example:

```json
{
  "kind": 9,
  "content": "Hello from the general channel!",
  "tags": [
    ["h", "dev-nostr"],
    ["i", "general"]
  ],
  "created_at": 1234567890,
  "pubkey": "...",
  "id": "...",
  "sig": "..."
}
```

## Channel Discovery

Clients MAY query:

```json
{
  "kinds": [39010],
  "#d": ["dev-nostr"]
}
```

Returns all channels for a group.

No global index is defined.

## Relay Behavior

Relays:

- MAY enforce access control
- SHOULD ensure `channel_id` uniqueness per group
- SHOULD reject messages with unknown `i` tags
- MUST enforce group moderation rules from NIP-29

## Client Behavior

Clients:

- SHOULD present channels per group as separate substreams
- MAY hide private channels user lacks access to
- SHOULD include `i` tag when posting to channels

## Backwards Compatibility

- Clients without support see all messages as a single timeline
- kind:9 messages without `i` remain valid
- NIP-29 semantics remain unchanged

## Relation to NIP-29

This NIP extends NIP-29:

- Channels are relay-scoped, inside groups
- `i` tag references channels (`c`)
- Introduces kind:39010 for channel metadata; messages remain kind:9
- Compatible with existing NIP-29 clients

This NIP is independent from NIP-28 and does not reuse its event kinds or semantics.

## Security Considerations

- Relays MUST enforce group-level moderation and channel rules
- Clients SHOULD avoid assuming channel equivalence across relays
- Deleted or renamed channels MUST be handled gracefully

## Indexers and Search Relays

Indexers SHOULD index `h` (group) and `i` (channel) for efficient queries.

- Queries can filter by group or channel without duplicating events
- Backfill from existing kind:9 messages is straightforward

### Example queries:

**All messages in a group:**

```json
{"kinds":[9],"#h":["dev-nostr"]}
```

**Messages in specific channel:**

```json
{"kinds":[9],"#h":["dev-nostr"],"#i":["general"]}
```

## Edge Cases

- **Channel deleted** → messages remain; clients MAY hide
- **Channel renamed** → update kind:39010 (new event with latest `created_at`); existing messages still valid
- **Message sent to unknown channel** → relay SHOULD reject
- **Forked relay** → channels may differ; clients SHOULD NOT assume equivalence across relays
- **Client without support** → sees all messages in single timeline
- **Reactions** (kind 7) → SHOULD include same `i` tag as parent message to maintain context

## Conclusion

NIP-91 introduces channels within groups, extending NIP-29, fully backward-compatible, and optimized for:

- relay moderation
- search/indexing
- client usability

