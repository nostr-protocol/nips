NIP-29a
======

Channels for Groups
------------------

`draft` `optional`

This NIP defines a standard for groups to create channels.

Channels are identified by a random string of any length that serves as an _id_.

There is no way to create a channel, what happens is just that relays (most likely when asked by admins of the groups) will create rules around some specific ids so these ids can serve as an actual channel, henceforth messages sent to that group will be subject to the rules of the channel.

## Admin-generated events

Group admins are supposed to generate the events that describe channel metadata. These are _addressable_ events signed by te admin keypair directly, with the group _id_ as the `d` tag and channel _id_ as the `t` tag.

## Channel identifier

A channel may be identified by a string in the format `<group-id>'<channel-id>`. For example, a group with _id_ `abcdef` and a channel with _id_ `1234` and hosted at the relay `wss://groups.nostr.com` would be identified by the string `groups.nostr.com'abcdef'1234`.

Channel identifiers must be strings restricted to the characters `a-z0-9-_`, and SHOULD be random in order to avoid name collisions.

When encountering just the `<group-id>` without the `'<channel-id>`, clients MAY infer `_` as the channel id, which is a special top-level channel dedicated to that group.

## The `h` tag

Events sent by users to groups (chat messages, text notes, moderation events etc) MUST have an `h` tag with the value set to the group _id_ and channel _id_.

## Channel management

## Event definitions

These are the events expected to be found in NIP-29a channels.

### Normal user-created events

Channel may accept any event kind, including chats, threads, long-form articles, calendar, livestreams, market announcements and so on. These should be as defined in their respective NIPs, with the addition of the `h` tag.

### User-related group management events

These are events that can be sent by users to manage their situation in a channel, they also require the `h` tag.

- *join request* (`kind:9031`)

Any user can send a kind `9031` event to the relay in order to request admission to the channel. Relays MUST reject the request if the user has not been added to the group. If a user is already a member, the event MUST be rejected with `duplicate: ` as the error message prefix.

```json
{
  "kind": 9031,
  "content": "optional reason",
  "tags": [
    ["h", "<group-id>"],
    ["t", "<channel-id>"],
    ["code", "<optional-invite-code>"]
  ]
}
```

The optional `code` tag may be used by the group to preauthorize acceptances in `closed` channels, together with the `kind:9009` `create-invite` moderation event.

- *leave request* (`kind:9032`)

Any user can send one of these events to the group in order to be automatically removed from the channel. The relay will automatically issue a `kind:9001` in response removing this user.

```json
{
  "kind": 9032,
  "content": "optional reason",
  "tags": [
    ["h", "<group-id>"],
    ["t", "<channel-id>"]
  ]
}
```

### Group state -- or moderation

These are events expected to be sent by the relay master key or by group admins -- and relays should reject them if they don't come from an authorized admin. They also require the `h` tag.

- *moderation events* (`kinds:9040-9060`) (optional)

Clients can send these events to a relay in order to accomplish a moderation action. Relays must check if the pubkey sending the event is capable of performing the given action based on its role and the relay's internal policy (see also the description of `kind:39003`).

```jsonc
{
  "kind": 90xx,
  "content": "optional reason",
  "tags": [
    ["h", "<group-id>"],
    ["t", "<channel-id>"],
    ["previous", /*...*/]
  ]
}
```

Each moderation action uses a different kind and requires different arguments, which are given as tags. These are defined in the following table:

| kind | name                | tags                                           |
| ---  | ---                 | ---                                            |
| 9061 | `put-user`          | `p` with pubkey hex and optional roles         |
| 9062 | `remove-user`       | `p` with pubkey hex                            |
| 9063 | `edit-metadata`     | fields from `kind:39000` to be modified        |
| 9064 | `delete-event`      | `e` with event id hex                          |
| 9065 | `create-channel`    |                                                |
| 9066 | `delete-channel`    |                                                |
| 9067 | `create-invite`     |                                                |

It's expected that the chnnel state (of who is an allowed member or not, who is an admin and with which permission or not, what are the channel name and picture etc) can be fully reconstructed from the canonical sequence of these events.

### Channel metadata events

These events contain the channel id in a `t` tag instead of the `d` tag. They MUST be created by the admin master key only and a single instance of each (or none) should exist at all times for each group. They are merely informative but should reflect the latest channel state (as it was changed by moderation events over time).

- *channel metadata* (`kind:39010`) (optional)

This event defines the metadata for the channel -- basically how clients should display it. It must be generated and signed by the admin. Relays shouldn't accept these events if they're signed by anyone else.

When this event is not found, clients may still connect to the channel, but treat it as having a different status, `unmanaged`,

```jsonc
{
  "kind": 39010,
  "content": "",
  "tags": [
    ["d", "<group-id>"],
    ["t", "<channel-id>"],
    ["name", "Pizza Lovers"],
    ["picture", "https://pizza.com/pizza.png"],
    ["about", "a group for people who love pizza"],
    ["public"], // or ["private"]
    ["open"] // or ["closed"]
  ]
  // other fields...
}
```

`name`, `picture` and `about` are basic metadata for the channel for display purposes. `public` signals the group can be _read_ by anyone, while `private` signals that only AUTHed users can read. `open` signals that anyone can request to join and the request will be automatically granted, while `closed` signals that members must be pre-approved or that requests to join will be manually handled.

- *group admins* (`kind:39011`) (optional)

Each admin is listed along with one or more roles. These roles SHOULD have a correspondence with the roles supported by the group, as advertised by the `kind:39003` event.

```jsonc
{
  "kind": 39011,
  "content": "list of admins for the pizza lovers group",
  "tags": [
    ["d", "<group-id>"],
    ["t", "<channel-id>"],
    ["p", "<pubkey1-as-hex>", "ceo"],
    ["p", "<pubkey2-as-hex>", "secretary", "gardener"],
    // other pubkeys...
  ],
  // other fields...
}
```

- *channel members* (`kind:39022`) (optional)

It's a list of pubkeys that are members of the group. Relays might choose to not to publish this information, to restrict what pubkeys can fetch it or to only display a subset of the members in it.

Clients should not assume this will always be present or that it will contain a full list of members.

```jsonc
{
  "kind": 39022,
  "content": "list of members for the pizza lovers group",
  "tags": [
    ["d", "<group-id>"],
    ["t", "<channel-id>"],
    ["p", "<admin1>"],
    ["p", "<member-pubkey1>"],
    ["p", "<member-pubkey2>"],
    // other pubkeys...
  ],
  // other fields...
}
```

## Implementation quirks

### Checking your own membership in a channel

The latest of either `kind:9000` or `kind:9001` events present in a group should tell a user that they are currently members of the group or if they were removed. In case none of these exist the user is assumed to not be a member of the group -- unless the group is `unmanaged`, in which case the user is assumed to be a member.

### Adding yourself to a channel

When a group is `open`, anyone can send a `kind:9021` event to it in order to be added, then expect a `kind:9000` event to be emitted confirming that the user was added. The same happens with `closed` groups, except in that case a user may only send a `kind:9021` if it has an invite code.

### Storing list of channels

A definition for `kind:10010` was included in [NIP-51](51.md) that allows clients to store the list of channels a user wants to remember being in.

### Using `unmanaged` relays

To prevent event leakage, when using `unmanaged` relays, clients should include the [NIP-70](70.md) `-` tag, as just the `previous` tag won't be checked by other `unmanaged` relays.

channels MAY be named without relay support by adding a `name` to the corresponding tag in a user's `kind 10010` channel list.
