NIP-66
======

Relay Discovery and Liveness Monitoring
-------------------

`draft` `optional`

This NIP defines events for relay discovery and the announcement of relay monitors.

## Relay Discovery Events

`30166` relay discovery events document relay characteristics inferred either from a relay's [NIP 11](https://github.com/nostr-protocol/nips/blob/master/11.md) document, or via probing.

Information corresponding to field in a relay's NIP 11 document MAY contradict actual values if monitors find that a different policy is implemented than is advertised.

`content` MAY include the stringified JSON of the relay's NIP-11 informational document.

The only required tag is the `d` tag, which MUST be set to the relay's [normalized](https://datatracker.ietf.org/doc/html/rfc3986#section-6) URL. For relays not accessible via URL, a hex-encoded pubkey MAY be used instead.

Other tags include:

### Round-Trip Time Tags

- `rtt-open` - The relay's open round-trip time in milliseconds.
- `rtt-read` - The relay's read round-trip time in milliseconds.
- `rtt-write` - The relay's write round-trip time in milliseconds.
- `rtt-dns` - The relay's DNS resolution round-trip time in milliseconds.

### Relay Classification Tags

- `n` - The relay's network type. SHOULD be one of `clearnet`, `tor`, `i2p`, `loki`
- `T` - The relay type. Enumerated [relay type](https://github.com/nostr-protocol/nips/issues/1282) formatted as `PascalCase`, e.g. `PrivateInbox`
- `N` - NIPs supported by the relay
- `R` - Keys corresponding to requirements per [NIP 11](https://github.com/nostr-protocol/nips/blob/master/11.md)'s `limitations` array, including `auth`, `writes`, `pow`, and `payment`. False values should be specified using a `!` prefix, for example `!auth`.
- `t` - A topic associated with this relay
- `k` - Accepted and unaccepted kinds (false values prepended by `!`)

### SSL/TLS Tags

- `ssl` - SSL/TLS certificate validity. SHOULD be `valid` or `!valid` (using the `!` prefix convention for false values).
- `ssl-issuer` - The Certificate Authority (CA) that issued the SSL certificate.
- `ssl-expires` - The SSL certificate expiration as a Unix timestamp in seconds.

### Geographic Tags

- `g` - A [NIP-52](https://github.com/nostr-protocol/nips/blob/master/52.md) geohash
- `geo-ip` - The resolved IP address of the relay.
- `geo-country` - The [ISO 3166-1 alpha-2](https://en.wikipedia.org/wiki/ISO_3166-1_alpha-2) country code.
- `geo-region` - The region or subdivision name.
- `geo-city` - The city name.
- `geo-lat` - The latitude coordinate as a decimal string.
- `geo-lon` - The longitude coordinate as a decimal string.
- `geo-tz` - The [IANA timezone](https://www.iana.org/time-zones) identifier.

### Network/ASN Tags

- `asn` - The Autonomous System Number.
- `asn-org` - The ASN organization name.
- `isp` - The Internet Service Provider name.

Tags with more than one value should be repeated, rather than putting all values in a single tag, for example `[["t", "cats"], ["t", "dogs"]]`, rather than `[["t", "cats", "dogs"]]`.

Example:

```json
{
  "id": "<eventid>",
  "pubkey": "<monitor's pubkey>",
  "created_at": "<created_at  [some recent date ...]>",
  "signature": "<signature>",
  "content": "<optional nip 11 document>",
  "kind": 30166,
  "tags": [
    ["d","wss://some.relay/"],
    ["n", "clearnet"],
    ["N", "40"],
    ["N", "33"],
    ["R", "!payment"],
    ["R", "auth"],
    ["rtt-open", "234"],
    ["rtt-read", "156"],
    ["rtt-write", "189"],
    ["rtt-dns", "45"],
    ["ssl", "valid"],
    ["ssl-issuer", "Let's Encrypt"],
    ["ssl-expires", "1735689600"],
    ["g", "ww8p1r4t8"],
    ["geo-ip", "93.184.216.34"],
    ["geo-country", "NL"],
    ["geo-region", "North Holland"],
    ["geo-city", "Amsterdam"],
    ["geo-lat", "52.3676"],
    ["geo-lon", "4.9041"],
    ["geo-tz", "Europe/Amsterdam"],
    ["asn", "15169"],
    ["asn-org", "Google LLC"],
    ["isp", "Google Cloud"],
    ["l", "en", "ISO-639-1"],
    ["t", "nsfw"]
  ]
}
```

## Relay Monitor Announcements

Kind `10166` relay monitor announcements advertise the author's intent to publish `30166` events. This event is optional and is intended for monitors who intend to provide monitoring services at a regular and predictable frequency.

Tags include:

- `frequency` - The frequency in seconds at which the monitor publishes events.
- `timeout` (optional) - The timeout values for various checks conducted by a monitor. Index `1` is the monitor's timeout in milliseconds. Index `2` describes what test the timeout is used for. If no index `2` is provided, it is inferred that the timeout provided applies to all tests.
- `c` - a lowercase string describing the checks conducted by a monitor. Examples include `open`, `read`, `write`, `auth`, `nip11`, `dns`, `geo`, `ssl`, and `asn`.
- `g` - [NIP-52](https://github.com/nostr-protocol/nips/blob/master/11.md) geohash tag

Monitors SHOULD also publish a `kind 0` profile and a `kind 10002` relay selections event.

Example:

```json
{
  "id": "<eventid>",
  "pubkey": "<monitor's pubkey>",
  "created_at": "<created_at  [some recent date ...]>",
  "signature": "<signature>",
  "content": "",
  "tags": [
    [ "timeout", "open", "5000"  ],
    [ "timeout", "read", "3000"  ],
    [ "timeout", "write", "3000" ],
    [ "timeout", "nip11", "3000" ],
    [ "timeout", "dns", "5000" ],
    [ "timeout", "ssl", "10000" ],
    [ "frequency", "3600" ],
    [ "c", "open" ],
    [ "c", "read" ],
    [ "c", "write" ],
    [ "c", "nip11" ],
    [ "c", "ssl" ],
    [ "c", "dns" ],
    [ "c", "geo" ],
    [ "c", "asn" ],
    [ "g", "ww8p1r4t8" ]
  ]
}
```