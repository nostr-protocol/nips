NIP-66
======

Relay Discovery and Liveness Monitoring
-------------------

`draft` `optional` `relay`

This NIP defines events for relay discovery and the announcement of relay monitors.

## Relay Discovery Events

Kind `30166` relay discovery events document relay characteristics inferred either from a relay's [NIP-11](https://github.com/nostr-protocol/nips/blob/master/11.md) document, or via probing.

Information corresponding to fields in a relay's NIP-11 document MAY contradict actual values if monitors find that a different policy is implemented than is advertised.

`content` MAY include the stringified JSON of the relay's NIP-11 informational document.

The only required tag is the `d` tag, which MUST be set to the relay's [normalized](https://datatracker.ietf.org/doc/html/rfc3986#section-6) URL. For relays not accessible via URL, a hex-encoded pubkey MAY be used instead.

### Basic Tags

- `n` - The relay's network type. SHOULD be one of `clearnet`, `tor`, `i2p`, `loki`
- `T` - The relay type. Enumerated [relay type](https://github.com/nostr-protocol/nips/issues/1282) formatted as `PascalCase`, e.g. `PrivateInbox`
- `N` - NIPs supported by the relay
- `R` - Keys corresponding to requirements per [NIP-11](https://github.com/nostr-protocol/nips/blob/master/11.md)'s `limitations` array, including `auth`, `writes`, `pow`, and `payment`. False values should be specified using a `!` prefix, for example `!auth`.
- `t` - A topic associated with this relay
- `k` - Accepted and unaccepted kinds (false values prepended by `!`)
- `l` - Language tag per [ISO-639-1](https://en.wikipedia.org/wiki/ISO_639-1). Index `1` is the language code, index `2` is the standard identifier (`ISO-639-1`).

### RTT (Round-Trip Time) Tags

Round-trip time measurements in milliseconds:

- `rtt-open` - Time to establish connection
- `rtt-read` - Time to receive first event after subscription
- `rtt-write` - Time to receive OK after publishing an event

### SSL/TLS Tags

SSL/TLS certificate information (clearnet `wss://` relays only):

- `ssl` - Certificate validity status: `valid` or `!valid`
- `ssl-expires` - Certificate expiration as Unix timestamp in seconds
- `ssl-issuer` - Certificate Authority (CA) organization name

### Network Tags

Network identification data derived from IP address lookup:

- `net-ip` - Resolved IPv4 address of the relay
- `net-ipv6` - Resolved IPv6 address of the relay (if available)
- `net-asn` - [Autonomous System Number](https://en.wikipedia.org/wiki/Autonomous_system_(Internet))
- `net-asn-org` - ASN organization name

### Geographic Tags

Geographic location data derived from IP address lookup:

- `g` - A [NIP-52](https://github.com/nostr-protocol/nips/blob/master/52.md) geohash
- `geo-country` - [ISO 3166-1 alpha-2](https://en.wikipedia.org/wiki/ISO_3166-1_alpha-2) country code
- `geo-city` - City name
- `geo-lat` - Latitude coordinate as decimal string
- `geo-lon` - Longitude coordinate as decimal string
- `geo-tz` - [IANA timezone](https://www.iana.org/time-zones) identifier

While `geo-lat` and `geo-lon` can be derived from the `g` (geohash) tag, they are included for convenience, allowing clients to read coordinates directly without implementing geohash decoding.

### Tag Formatting

Tags with more than one value should be repeated, rather than putting all values in a single tag, for example `[["t", "cats"], ["t", "dogs"]]`, rather than `[["t", "cats", "dogs"]]`.

### Example

```json
{
  "id": "<eventid>",
  "pubkey": "<monitor's pubkey>",
  "created_at": 1703116800,
  "sig": "<signature>",
  "content": "<optional nip11 document>",
  "kind": 30166,
  "tags": [
    ["d", "wss://relay.example.com/"],
    ["n", "clearnet"],
    ["N", "1"],
    ["N", "11"],
    ["N", "50"],
    ["R", "!payment"],
    ["R", "!auth"],
    ["T", "PublicGeneralPurpose"],
    ["t", "bitcoin"],
    ["g", "u173zq37x"],
    ["l", "en", "ISO-639-1"],

    ["rtt-open", "89"],
    ["rtt-read", "123"],
    ["rtt-write", "156"],

    ["ssl", "valid"],
    ["ssl-expires", "1735689600"],
    ["ssl-issuer", "Let's Encrypt"],

    ["net-ip", "93.184.216.34"],
    ["net-ipv6", "2606:2800:220:1:248:1893:25c8:1946"],
    ["net-asn", "15169"],
    ["net-asn-org", "Google LLC"],

    ["geo-country", "NL"],
    ["geo-city", "Amsterdam"],
    ["geo-lat", "52.3676"],
    ["geo-lon", "4.9041"],
    ["geo-tz", "Europe/Amsterdam"]
  ]
}
```

## Relay Monitor Announcements

Kind `10166` relay monitor announcements advertise the author's intent to publish `30166` events. This event is optional and is intended for monitors who intend to provide monitoring services at a regular and predictable frequency.

### Tags

- `frequency` - The frequency in seconds at which the monitor publishes events.
- `timeout` (optional) - The timeout values for various checks conducted by a monitor. Index `1` describes what test the timeout is used for. Index `2` is the monitor's timeout in milliseconds. If no index `1` is provided, it is inferred that the timeout provided applies to all tests.
- `c` - A lowercase string describing the checks conducted by a monitor. See table below for valid values.
- `g` - [NIP-52](https://github.com/nostr-protocol/nips/blob/master/52.md) geohash indicating the monitor's geographic location

### Check Types

The `c` tag declares which checks a monitor performs. Each check type produces specific tags in kind `30166` events:

| Check   | Description                  | Output Tags                                                   |
|---------|------------------------------|---------------------------------------------------------------|
| `open`  | Connection test              | `rtt-open`                                                    |
| `read`  | Read/subscription test       | `rtt-read`                                                    |
| `write` | Write/publish test           | `rtt-write`                                                   |
| `nip11` | NIP-11 document fetch        | `content`                                                     |
| `ssl`   | SSL/TLS certificate check    | `ssl`, `ssl-expires`, `ssl-issuer`                            |
| `geo`   | Geographic location lookup   | `g`, `geo-country`, `geo-city`, `geo-lat`, `geo-lon`, `geo-tz`|
| `net`   | Network/ASN lookup           | `net-ip`, `net-ipv6`, `net-asn`, `net-asn-org`                |

Monitors SHOULD also publish a `kind 0` profile and a `kind 10002` relay selections event.

### Example

```json
{
  "id": "<eventid>",
  "pubkey": "<monitor's pubkey>",
  "created_at": 1703116800,
  "sig": "<signature>",
  "content": "",
  "kind": 10166,
  "tags": [
    ["frequency", "3600"],

    ["timeout", "open", "5000"],
    ["timeout", "read", "3000"],
    ["timeout", "write", "3000"],
    ["timeout", "nip11", "3000"],
    ["timeout", "ssl", "5000"],

    ["c", "open"],
    ["c", "read"],
    ["c", "write"],
    ["c", "nip11"],
    ["c", "ssl"],
    ["c", "geo"],
    ["c", "net"],

    ["g", "u173zq37x"]
  ]
}
```

## Use Cases

### SSL/TLS Monitoring
- **Security monitoring**: Identify relays with expired or invalid certificates
- **Proactive alerts**: Warn operators before certificate expiration
- **Trust assessment**: Evaluate relay trustworthiness based on Certificate Authority

### Geographic Filtering
- **Privacy-aware routing**: Avoid relays in specific jurisdictions
- **Latency optimization**: Select geographically proximate relays
- **Regulatory compliance**: GDPR, data residency requirements

### Network Diversity
- **Redundancy planning**: Diversify relay selection across different networks
- **Censorship resistance**: Identify relays across different Autonomous Systems
- **Outage correlation**: Link relay issues to network-wide problems

## Privacy Considerations

Geographic and network information may be sensitive for relay operators who prefer anonymity. All tags defined in this NIP are optional, allowing monitors to publish only the information they deem appropriate.

Relay operators concerned about privacy can:
- Use Tor/I2P network types (overlay networks don't expose public IPs)
- Request monitors exclude their relay from detailed lookups
- Run their own monitor publishing limited information
