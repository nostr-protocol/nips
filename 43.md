NIP-43
======

Private DM
----------

`draft` `optional`

This direct message (DM) scheme between two participants is end-to-end encrypted, hides
most metadata, has forward secrecy and aims to minimize spam.

This NIP currently uses [NIP-44](44.md) v2 encryption.

## Flow

- Before sending a DM to someone (`B`), an user (`A`) picks a random privkey to be used as chat session (`session-privkey`);
- `A` signs DMs with `session-privkey` and publishes them to `A` and `B` [NIP-65](65.md) `read` relays;
- Meanwhile, `A` sends `session-privkey` to `B` through B `read` relays, representing the chat session;
- `A` also stores `session-privkey` to themselves linking it to `B` pubkey (representing `A-B` chat session);
- Upon receiving `session-privkey`, `B` stores the key linking it to `A` pubkey (also representing `A-B` chat session) and sends a chat session acceptance to `A`. Otherwise `B` ignores the key;
- `B` can fetch DMs from that session's pubkey, filtering by `author`;
- `B` can send back DMs by signing them with the same `session-privkey`.

Note that:
- `A` can resend the same session key (same `kind:1044` rumor, **reusing its `.created_at`**) anytime they want while there is no acceptance from `B`, to make sure `B` didn't miss it;
- `B` could had sent a session to `A` almost at the same time.
In that case, the newest (`kind:1044` rumor's `.created_at`) of the two sessions should be used by both participants. They may also check a single
time for DMs already sent from the older session before discarding it. If the `.created_at` of both sessions are exactly the same,
the users will pick the first one after sorting the `.id` (of the `kind:1044` rumors) by descending order.

Important:
- By convention, after three weeks the session expires.
Either `A` or `B` will need to restart the flow with a new random privkey as session
when sending new DMs.

## Chat Session

The "Chat Session Envelope" is a [NIP-59](59.md) gift wrap event but with a specific kind: `1043`.

The NIP-44 encryption when wrapping use the random author's privkey and the recipient's pubkey to generate the conversation key (CK).
When sealing the encryption uses the main sender's privkey and the recipient's pubkey.
Both encryptions use the default salt to generate the CK.

It MUST include [NIP-13](13.md) PoW with atleast 16 difficulty.
Receiving client MUST ignore it if below 16.
Relays SHOULD block it if below 16.
Relays SHOULD require increasing PoW difficulty the more `kind:1043` events are sent to the same pubkey in a short time.
Relays SHOULD block it if of byte size higher than 3KB.

It has a `p` tag set to the recipient's pubkey.
Relays SHOULD require users to [NIP-42](42.md) `AUTH` as the `p` tagged pubkey when requesting the event.

The NIP-59 rumor is a `kind:1044` "Chat Session Request" event.
It's `.content` is the session's privkey.

By convention, the session expires 3 weeks after the rumor's `.created_at` value.

The "Chat Session Envelope" event should be sent to atleast one of the recipient's NIP-65 `read` relays.

Event example:

```js
{
  "kind": 1043,
  "pubkey": "<random-pubkey>",
  "tags": [
    ["p", "<pubkey-B>"],
    ["nonce", "65962", "16"] // atleast 16 PoW difficulty
  ],
  "content": "<nip44EncryptV2(JSON.stringify({
    "kind": 13, // seal
    "pubkey" "<pubkey-A>",
    "tags": [],
    "content": "<nip44EncryptV2(JSON.stringify({
      "id": "<...>",
      "kind": 1044,
      "pubkey" "<pubkey-A>",
      "tags": [],
      "content": "<session-privkey>",
      "created_at": 1702711000
      // no .sig field
    }))>",
    "created_at": 0
    // ....other fields
  }))>",
  "created_at": 1702711000 // now
  // ...other fields
}
```

## Chat Session List

The [NIP-51](51.md) `kind:10043` is the user's "Chat Session List" event.

It encrypts `s` (session) tags using the author's own keypair with default salt
as arguments to generate the NIP-44 conversation key.

An `s` tag's 1st value is the `pubkey` of the other side of the chat.
The 2nd value is the session's `privkey`.
The 3rd value is the expiration timestamp in seconds and is three weeks ahead
of the `kind:1044`'s `.created_at` value.
The 4th value if present is set to "1", meaning the other chat participant accepted the chat session
(see ["Chat Session Acceptance" section](#chat-session-acceptance)).

`s` tags of expired sessions should be kept to indicate active chats.

Relays SHOULD require users to [NIP-42](42.md) `AUTH` as the event author when requesting the event.

The user should publish the event to all of their own NIP-65 `write` relays.

Event example:

```js
{
  "kind": 10043,
  "pubkey": "<pubkey-B>"
  "content": "<nip44EncryptV2(JSON.stringify([
    ["s", "<pubkey-A>", "<session-privkey>", "1704525400", "1"],
    // other "s" tags
  ]))>",
  // ...other fields
}
```

## Session Channel

The session channel is simply made of the set of NIP-59 `kind:1059` events
with the session pubkey as their author.

Either the sender or the recipient may delete these events because both of them know
the session's privkey. Therefore, clients should store them locally to keep their users in control
of the DMs lifecycle.

**Important**: The NIP-44 encryption when wrapping and when sealing session channel events
uses the first 32 characters of the session's `privkey` as salt
when generating the conversation key (CK).
This ensures forward secrecy when creating a new session because both users
are supposed to store just the last session's `privkey`
in the "Chat Session List" event.

Note that the CK generation does **NOT** use the session privkey nor pubkey as arguments.
Instead use the two users' keys.

### DM

The DM is a `kind:14` NIP-59 rumor.

This event should be sent to atleast one of the recipient's NIP-65 `read` relays
and to atleast one of the sender's `read` relays.
This way, an user will only have to fetch DMs from their own set of `read` relays.

DM event example:

```js
{
  "kind": 1059, // gift wrap
  "pubkey": "<session-pubkey>",
  "tags": [],
  "content": "<nip44EncryptV2(JSON.stringify({
    "kind": 13, // seal
    "pubkey" "<pubkey-A>",
    "tags": [],
    "content": "<nip44EncryptV2(JSON.stringify({
      "id": "<...>",
      "kind": 14, // DM
      "pubkey" "<pubkey-A>",
      "tags": [],
      "content": "Hello, User B",
      "created_at": 1702711000 // now
      // no .sig field
    }))>",
    "created_at": 0
    // ....other fields
  }))>",
  "created_at": 1702711000 // now
  // ...other fields
}
```

### Chat Session Acceptance

It is a `kind:1045` rumor.

It's `.content` is set to the received "Chat Session"'s content which is enough to
accept the session identified by the `.pubkey` and the `.content` (session privkey).

Without the acceptance by the recipient, the sender may keep resending the same
`kind:1044` session in case the recipient had missed it.
There is no chat session *rejection* rumor, though, to keep recipient's online
status private.

This event should be sent to atleast one of the chat session requester's NIP-65 `read` relays.

### Last Received At

Optionally, the `created_at` of a `kind:17` NIP-59 rumor
informs the last time an user's client received DMs from the other participant.

This event should be sent to atleast one of the DM author's NIP-65 `read` relays.

### Last Read At

Optionally, the `created_at` of a `kind:18` NIP-59 rumor
informs the last time an user read DMs from the other participant.

This event should be sent to atleast one of the DM author's NIP-65 `read` relays.
