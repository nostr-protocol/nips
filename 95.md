NIP-95
======

File Storage
------------

`draft` `optional` `author:arthurfranca` `author:Semisol` `author:frbitten` `author:staab`

## Motivation

This NIP defines a way to turn a relay into a storage service.
The spec doesn't use regular nostr events through websockets for
storing, requesting nor retrieving data because it would be inneficient.

## Relay Adaptation

Relays wishing to be used as file storage should opt-in by making available
an https route at `/nip95(/<sha256-file-hash>)` for handling files as described below.
They may announce support with [NIP-11](11.md) `supported_nips` field.
Other ways of advertising NIP-95 support may be described later.

## Upload

A file can be uploaded one at a time to `https://relay.domain/nip95` as `multipart/form-data` content type using `POST` method with the file object set to the `file` form data field.

Clients must add a [NIP-98](98.md) `Authorization` header with the encoded `payload` tag set to the base64-encoded 256-bit SHA-256 hash of the file (not the hash of the whole request body).
If using an html form, use an `Authorization` form data field instead.

Others custom form data fields may be added depending on specific relay support.

The `filename` embedded in the file may not be honored by the relay, which can internally store just the filename as the SHA-256 hash value ignoring extra metadata.

Relays must reject the upload if the `payload` tag value contains an already used SHA-256 hash or
it isn't the same of the received file.

The upload response is a json as follows:

```js
{
  nip95: {
    // SHA-256 hash. Empty string if unsuccessful
    x: "719171db19525d9d08dd69cb716a18158a249b7b3b3ec4bbdec5698dca104b7b"
  },
  errors: {
    // Empty array if successful
    nip95: ['error 1', 'error 2']
  }
}
```

Clients may upload the same file to one or many relays.
After successful upload, the client may optionally generate and send to any set of relays an [NIP-94](94.md) event with atleast these tags:

```js
[
  ["url", "https://relay.domain/nip95/719171db19525d9d08dd69cb716a18158a249b7b3b3ec4bbdec5698dca104b7b"],
  ["x", "719171db19525d9d08dd69cb716a18158a249b7b3b3ec4bbdec5698dca104b7b"]
]
```

If the file upload was made to more than one relay, `r` query params must be added to the url string, containing each of the relays used in successful upload operations. For example:

```js
[
  ["url", "https://relay.domain/nip95/<sha256-file-hash>?r=relay.domain2&r=relay.domain3&r=relay.domain4"],
  ["x", <the-hash>]
]
```

Alternativelly, instead of using NIP-94, one can share or embbed on a note just the above url, optionally with added [NIP-54](54.md) inline metadata.

File compression is optionally done at the client, **never on relay**, before uploading.
This is done to assure the same file hash result, no matter to how many relays one may upload.

## Download

Relays must make available the route path `/nip95/<sha256-file-hash>` with `GET` method for file download.

Clients should send a `GET` request to the relay url in the format `https://relay.domain/nip95/<sha256-file-hash>?r=relay.domain2&r=relay.domain3`.

If the relay doesn't have the file anymore, it should issue a 302 http redirect to the next relay included as `r` query param. For example, issue a redirect to `https://relay.domain2/nip95/<sha256-file-hash>?r=relay.domain3`

## Deletion

Relays must make available the route path `/nip95/<sha256-file-hash>` with `DELETE` method for file deletion.

Clients should send a `DELETE` request to the relay url in the format `https://relay.domain/nip95/<sha256-file-hash>`. It must include a NIP-98 `Authorization` header.

The relay should reject deletes from users other than the original uploader.

The response is similar to the json sent on uploads.
